{% load static %}
<!DOCTYPE html>
<html lang="{{ document_lang|default:'en' }}">
<head>
    <meta charset="utf-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Service Ratings Widget</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
    <style> 
        :root {
            --sidebar-width: 54px;
            --color-basic: #A0A0A0;
            --color-advanced: #E85D04; /* Darker Orange to match image */
            --color-pro: #FFD700; /* Gold */
            --color-text-main: #333;
            --font-stack: "Montserrat", sans-serif;
        }

        html, body { overflow: visible; overflow-x: visible; }
        body, button, input, select, textarea { margin: 0; padding: 0; background: transparent; font-family: var(--font-stack); -webkit-font-smoothing: antialiased; }

        #rcs-widget-container {
            position: fixed;
            top: 50%;
            right: 0;
            z-index: 9999;
            transform: translateY(-50%);
        }

        .flex-col {
            display: flex;
            flex-direction: column;
            align-items: center;
        }   

        /* --- Collapsed State --- */
        #rcs-widget-collapsed {
            width: var(--sidebar-width);
            min-height: 220px;
            border-radius: 6px 0 0 6px; /* Sharper corners */
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            transition: transform 0.3s ease;
        }
        
        #rcs-widget-collapsed:hover { transform: translateX(-4px); }

        .collapsed-stars { display: flex; flex-direction: column; gap: 8px; }
        .star { font-size: 20px; line-height: 1; color: rgba(255,255,255,0.4); }
        .star.filled { color: #fff; }

        /* Plan-specific Collapsed Backgrounds */
        .plan-basic #rcs-widget-collapsed { background: var(--color-basic); }
        .plan-advanced #rcs-widget-collapsed { background: var(--color-advanced); }
        .plan-pro #rcs-widget-collapsed { background: var(--color-pro); }

        /* --- Expanded State --- */
        #rcs-widget-expanded {
            display: none;
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%) translateX(20px);
            opacity: 0;
            background: #fff;
            border-radius: 8px; /* Slightly sharper */
            box-shadow: 0 10px 40px rgba(0,0,0,0.25);
            overflow: hidden;
            min-width: 420px; /* Slightly wider */
            min-height: 260px;
        }

        .expanded-layout { display: flex; height: 100%; min-height: 260px; }
        
        /* Sidebar */
        .sidebar {
            width: 66px; /* Wider sidebar */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px 0;
        }
        .sidebar-stars { display: flex; flex-direction: column; gap: 7px; }
        
        /* Content Area */
        .content {
            flex: 1;
            padding: 28px;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        /* Corner Brackets - Thicker & Better Aligned */
        .corner-bracket {
            position: absolute;
            width: 26px; height: 26px;
            border-color: #333; border-style: solid;
            opacity: 0.9;
        }
        .tl { top: 23px; left: 21px; border-width: 5px 0 0 5px; height: 30px; width: 30px; }
        .tr { top: 23px; right: 21px; border-width: 5px 5px 0 0; width: 30px; height: 30px; }

        /* --- Plan Specific Styles --- */

        /* BASIC */
        .plan-basic .sidebar { background: var(--color-basic); }
        .plan-basic .content { text-align: center; }
        .basic-text { font-size: 13px; color: #333; margin-bottom: 24px; font-weight: 500; }
        .cta-btn-large {
            background: #222; color: #fff; width: 100%; padding: 18px;
            border: none; font-weight: 800; font-size: 15px; cursor: pointer;
            text-transform: uppercase; letter-spacing: 0.5px;
        }
        .verified-logo { 
            margin-top: 24px; 
            text-transform: uppercase; 
            font-size: 19.3px; 
            color: #333; 
            {% comment %} letter-spacing: 4px; {% endcomment %}
            text-align: center;
            font-weight: 600; /* Sharp but not too bold */
        }
        /* Increased Logo Size significantly */
        .verified-logo img { height: 48px; margin-top: 10px; display: block; margin-left: auto; margin-right: auto;}

        /* ADVANCED */
        .plan-advanced .sidebar { background: var(--color-advanced); }
        .mini-star { font-size: 26px; color: rgba(255,255,255,0.4); }
        
        /* Advanced & Basic Sidebar Stars: All White */
        .plan-advanced .sidebar-stars .mini-star.filled, 
        .plan-basic .sidebar-stars .mini-star.filled { 
            color: #fff !important; 
            opacity: 1; 
            text-shadow: 0 1px 2px rgba(0,0,0,0.2); 
        }

        
        .plan-advanced .rating-row, .plan-pro .rating-row {
            display: flex; justify-content: space-between; align-items: center;
            margin: 8px; 
            font-weight: 600;
            text-transform: uppercase; letter-spacing: 0.5px;
            font-family: var(--font-stack);
            
        }
        .plan-advanced .rating-stars, .plan-pro .rating-stars { 
            color: #333; font-size: 16px; letter-spacing: 2px; display: flex; gap: 1px;
        }
        .plan-advanced .rating-stars .filled, .plan-pro .rating-stars .filled { color: #333; }
        .plan-advanced .rating-stars .empty, .plan-pro .rating-stars .empty { color: #ccc; }
        
        .plan-basic .stats-bar,
        .plan-advanced .stats-bar, .plan-pro .stats-bar {
            background: #222; color: #fff; padding: 14px 20px; margin-top: 24px;
            display: flex; justify-content: space-between; align-items: center;
            position: relative;
        }
        .plan-basic .stats-left,
        .plan-advanced .stats-left, .plan-pro .stats-left { display: flex; flex-direction: column; justify-content: center; }
        .plan-basic .stats-pct,
        .plan-advanced .stats-pct, .plan-pro .stats-pct { font-size: 50px; font-weight: 700; line-height: 0.85;}
        .plan-basic .stats-label,
        .plan-advanced .stats-label, .plan-pro .stats-label { font-size: 12px; font-weight: 700; text-transform: uppercase; margin-top: 6px; letter-spacing: 0.5px; opacity: 0.9; }
        
        .plan-basic .btn-outline,
        .plan-advanced .btn-outline, .plan-pro .btn-outline {
            border: 2px solid #fff; 
            background: transparent; color: #fff;
            padding: 6px 10px; 
            font-size: 14px; /* Reduced from 19px to fit translation */
            font-weight: 700; text-transform: uppercase;
            cursor: pointer;
            text-align: center;
            line-height: 1.2;
            min-width: 80px; 
            letter-spacing: 0.5px;
            box-shadow: none;
            border-radius: 0;
            flex-shrink: 0; /* Never shrink - keep button visible */
        }
        .plan-basic .btn-outline:hover,
        .plan-advanced .btn-outline:hover, .plan-pro .btn-outline:hover { background: #fff; color: #000; }

        /* PRO */
        .plan-pro .sidebar { background: var(--color-pro); }
        
        /* Stars fill from bottom to top visually */
        .plan-pro .sidebar-stars { flex-direction: column-reverse; }

        /* Pro Stars: VISUAL Top Star (DOM last-child) White, others Red-Orange */
        /* Only apply color to .filled stars so empty ones show as empty */
        .plan-pro .sidebar-stars .mini-star.filled { color: #E74C3C !important; text-shadow: none; opacity: 1; }
        .plan-pro .sidebar-stars .mini-star:last-child.filled { color: #fff !important; text-shadow: 0 1px 2px rgba(0,0,0,0.2); }

        /* Stats bar - gap between 100% and ZOBRAZIT RECENZE button */
        .plan-basic .stats-bar,
        .plan-advanced .stats-bar,
        .plan-pro .stats-bar { 
            position: relative;
            display: flex; 
            align-items: center; 
            justify-content: space-between;
            gap: 32px;
        }
        
        .plan-basic .stats-bar .stats-left,
        .plan-advanced .stats-bar .stats-left,
        .plan-pro .stats-bar .stats-left {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            flex-shrink: 0;
            margin-right: 24px; /* Extra gap between 100% and VIEW REVIEWS button */
        }
        
        /* Keep view reviews button always visible */
        .plan-basic .stats-bar .btn-outline,
        .plan-advanced .stats-bar .btn-outline,
        .plan-pro .stats-bar .btn-outline {
            flex-shrink: 0;
            display: flex !important;
        } 

    </style>
</head>
<body class="plan-{{ user.plan|default:'basic' }}">

    <div id="rcs-widget-container">
        <!-- COLLAPSED WIDGET -->
        <div id="rcs-widget-collapsed">
            <!-- Collapsed stars logic: Show accurate average -->
            <div class="collapsed-stars">
                {% for i in "12345" %}
                    {% if forloop.counter <= avg_main|default:0 %}
                        <div class="star filled">★</div>
                    {% else %}
                        <div class="star">★</div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>

        <!-- EXPANDED WIDGET -->
        <div id="rcs-widget-expanded">
            <div class="expanded-layout">
                <!-- SIDEBAR -->
                <div class="sidebar">
                    <div class="sidebar-stars">
                        {% for i in "12345" %}
                            {% if forloop.counter <= avg_main|default:0 %}
                                <div class="mini-star filled">★</div>
                            {% else %}
                                <div class="mini-star">★</div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>

                <!-- CONTENT -->
                <div class="content">
                    <!-- Decor Corners -->
                    <div class="corner-bracket tl"></div>
                    <div class="corner-bracket tr"></div>

                    <!-- EXPIRED OVERRIDE -->
                    {% if show_expired_message %}
                         <div style="text-align:center; color: #d00; font-weight: bold;">
                             {{ widget_strings.expired_title|default:'PLAN EXPIRED' }}<br>
                             <small>{{ widget_strings.expired_subtitle }}</small>
                         </div>
                    {% else %}

                        <!-- BASIC LAYOUT -->
                        {% if user.plan == 'basic' %}
                            <div class="basic-text">{{ verified_text|default:'The rating is based on verified consumer reviews.' }}</div>
                            <button class="cta-btn-large" onclick="parent.location.href='/api/reviews/public-reviews/{{ user.id }}/'">
                                {{ click_here_text|default:'CLICK HERE TO SEE REVIEWS' }}
                            </button>
                            
                            <div class="stats-bar">
                                <div class="stats-left">
                                    <span class="stats-pct">{{ positive_percentage }}%</span>
                                    <span class="stats-label">{{ positive_label_text|default:'POSITIVE REVIEWS' }}</span>
                                </div>
                                <button class="btn-outline flex-col" onclick="parent.location.href='/api/reviews/public-reviews/{{ user.id }}/'" style="
                                        display: flex;
                                        flex-direction: column;
                                        align-items: center;
                                    "><div>{{ widget_strings.click_part1|default:'CLICK' }}</div><div>{{ widget_strings.click_part2|default:'HERE' }}</div>
                                </button>
                            </div>
                            
                            <div class="verified-logo" style="
                                display: flex;
                                flex-direction: column;
                                align-items: stretch;
                                justify-content: center;
                            "><div><span style="
                                letter-spacing: 19px;
                            ">{{ widget_strings.verified_part1|default:'VERIFIED' }}</span> <span class="by" style="
                                letter-spacing: 15px;
                            ">{{ widget_strings.verified_part2|default:'BY' }}</span></div>
                                <div><img src="https://www.level-4u.com/images/levelblack.png" alt="LEVEL"></div>
                            </div>
                        {% endif %}

                        <!-- ADVANCED & PRO LAYOUT -->
                        {% if user.plan == 'advanced' or user.plan == 'pro' %}
                            <!-- Category-based rating rows (from business category); fallback to default 3 if none -->
                            {% if category_ratings_data %}
                                {% for item in category_ratings_data %}
                                <div class="rating-row">
                                    <span>{{ item.label }}</span>
                                    <span class="rating-stars">
                                        {% for i in "12345" %}
                                            <div class="{% if forloop.counter <= item.avg_stars %}filled{% else %}empty{% endif %}">★</div>
                                        {% endfor %}
                                    </span>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="rating-row">
                                    <span>{{ widget_strings.logistics|default:'LOGISTICS' }}</span>
                                    <span class="rating-stars">
                                        {% for i in "12345" %}
                                            <div class="{% if forloop.counter <= avg_logistics|default:0|add:0 %}filled{% else %}empty{% endif %}">★</div>
                                        {% endfor %}
                                    </span>
                                </div>
                                <div class="rating-row">
                                    <span>{{ widget_strings.delivery|default:'DELIVERY' }}</span>
                                    <span class="rating-stars">
                                        {% for i in "12345" %}
                                            <div class="{% if forloop.counter <= avg_communication|default:0|add:0 %}filled{% else %}empty{% endif %}">★</div>
                                        {% endfor %}
                                    </span>
                                </div>
                                <div class="rating-row">
                                    <span>{{ widget_strings.communication|default:'COMMUNICATION' }}</span>
                                    <span class="rating-stars">
                                        {% for i in "12345" %}
                                            <div class="{% if forloop.counter <= avg_communication|default:0|add:0 %}filled{% else %}empty{% endif %}">★</div>
                                        {% endfor %}
                                    </span>
                                </div>
                            {% endif %}

                            <div class="stats-bar">
                                <div class="stats-left">
                                    <span class="stats-pct">{{ positive_percentage }}%</span>
                                    <span class="stats-label">{{ positive_label_text|default:'POSITIVE REVIEWS' }}</span>
                                </div>
                                <button class="btn-outline flex-col" onclick="parent.location.href='/api/reviews/public-reviews/{{ user.id }}/'" style="
                                        display: flex;
                                        flex-direction: column;
                                        align-items: center;
                                    "><div>{{ widget_strings.click_part1|default:'CLICK' }}</div><div>{{ widget_strings.click_part2|default:'HERE' }}</div>
                                </button>
                            </div>
                            <div class="verified-logo" style="
                                display: flex;
                                flex-direction: column;
                                align-items: stretch;
                                justify-content: center;
                            "><div><span style="
                                letter-spacing: 19px;
                            ">{{ widget_strings.verified_part1|default:'VERIFIED' }}</span> <span class="by" style="
                                letter-spacing: 6px;
                            ">{{ widget_strings.verified_part2|default:'BY' }}</span></div>
                                <div><img src="https://www.level-4u.com/images/levelblack.png" alt="LEVEL"></div>
                            </div>
                        {% endif %}

                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- JS for Interaction -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const collapsed = document.getElementById('rcs-widget-collapsed');
            const expanded = document.getElementById('rcs-widget-expanded');
            const container = document.getElementById('rcs-widget-container');
            let isExpanded = false;
            let isAnimating = false;

            function openWidget() {
                if (isExpanded || isAnimating) return;
                isAnimating = true;

                // Prepare expanded
                expanded.style.display = 'block';
                expanded.style.opacity = '0';
                expanded.style.transform = 'translateY(-50%) translateX(20px) scale(0.95)';
                expanded.offsetHeight; // Force reflow

                // Animate collapsed out
                collapsed.style.transform = 'translateX(20px)';
                collapsed.style.opacity = '0';

                setTimeout(() => {
                    collapsed.style.display = 'none';
                    // Animate expanded in
                    expanded.style.opacity = '1';
                    expanded.style.transform = 'translateY(-50%) translateX(0) scale(1)';
                    expanded.style.transition = 'all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1)';
                    
                    setTimeout(() => { isExpanded = true; isAnimating = false; }, 400);
                }, 150);
            }

            function closeWidget() {
                if (!isExpanded || isAnimating) return;
                isAnimating = true;
                
                // Animate expanded out
                expanded.style.opacity = '0';
                expanded.style.transform = 'translateY(-50%) translateX(20px) scale(0.95)';

                setTimeout(() => {
                    expanded.style.display = 'none';
                    collapsed.style.display = 'flex';
                    collapsed.style.opacity = '0';
                    collapsed.style.transform = 'translateX(20px)';
                    collapsed.offsetHeight;

                    collapsed.style.opacity = '1';
                    collapsed.style.transform = 'translateX(0)';

                    setTimeout(() => { isExpanded = false; isAnimating = false; }, 400);
                }, 300);
            }

            collapsed.addEventListener('click', function(e) { e.stopPropagation(); openWidget(); });
            document.addEventListener('click', function(e) { 
                if (isExpanded && !container.contains(e.target)) closeWidget(); 
            });
            expanded.addEventListener('click', function(e) { e.stopPropagation(); });
        });
    </script>
</body>
</html>